<!DOCTYPE html>
<html>
<head>
	<title>Singapore Merchandise Trade</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
	<div id="graph" style="width:800px;text-align:center;">
		<div id="chart-area"></div>
		<input type="range" min="0" max="170" value="1" class="slider" id="rangeSlider"  style="width:80%;">
		<br> 
		<button id="play" onclick="pausePlay()" value=1 >Pause</button>
		<button id="reset" onclick="reset()">Reset</button>
	</div>
	<script>
		var margin = { left:50, right:100, top:40, bottom:150 }
    	var height = 550 - margin.top - margin.bottom
    	var width = 650 - margin.left - margin.right

		var svg = d3.select("#chart-area").append("svg")
		    .attr("width", width + margin.left + margin.right)
		    .attr("height", height + margin.top + margin.bottom)
		    .on("click", pausePlay);

		var g = svg.append("g")
		    .attr("transform", "translate(" + margin.left + ", " + margin.top + ")")


		 var gBorder = svg.append("rect")
			.attr("width", width + margin.left + margin.right)
		    .attr("height", height + margin.top + margin.bottom)
		    .attr("x", 0)
		    .attr("y", 0)
		    .style("fill", "none")
		    .style("stroke", "#708090")

		var xScale = d3.scaleLinear()
			.domain([0, 20000000]) //Max import value derived from data cleaning - 17254772.0
			.range([0, width])

		var yScale = d3.scaleLinear()
			.domain([0, 20000000]) //Max export value derived from data cleaning - 19636632.0
			.range([height , 0])

		var zScale = d3.scaleLinear() //Scale for radius of circles
			.domain([0,40000000])
			.range([0, 65])

		var regions = ['Europe', 'Asia', 'Americas', 'Oceania', 'Others']
		var colorPalette = ['#66c2a5', '#fc8d62', '#8da0cb', '#e78ac3']
		var colorScale = d3.scaleOrdinal(d3.schemePastel2)
			.domain(regions)
			.range(colorPalette)


		// X Axis

		var xAxisGroup = g.append("g")
			.attr("class", "x-axis")
			.attr("transform", "translate(" + margin.left + "," + (height+margin.top)+ ")")	
		var xAxisCall = d3.axisBottom(xScale)
			.ticks(5).tickFormat(function (d) {
			// Divide ticks by 1000 and format with comma
			// To give ticks in millions
				return d3.format(",")(d/1000)
			})
		xAxisGroup.call(xAxisCall)
		xAxisGroup.selectAll("path").style("stroke", "#708090");
		xAxisGroup.selectAll("line").style("stroke", "#708090");

		// Y Axis

		var yAxisGroup = g.append("g")
			.attr("class", "y-axis")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
		var yAxisCall = d3.axisLeft(yScale)
			.ticks(5).tickFormat(function (d) {
				// Divide ticks by 1000 and format with comma
				// To give ticks in millions
				return d3.format(",")(d/1000)
			})
		yAxisGroup.call(yAxisCall)
		yAxisGroup.selectAll("path").style("stroke", "#708090");
		yAxisGroup.selectAll("line").style("stroke", "#708090");


		// x Axis Labels
		g.append("text")
			.attr("y", height + 2*margin.top)
			.attr("x", (width + margin.right + margin.left)/2)
			.style("text-anchor", "middle")
			.style("font-family", "Arial")
			.style("font-weight", "bold")
			.style("fill", "#2F4F4F")
			.text("Merchandise Imports (SGD, millions)")


		// y Axis Labels
		g.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 0)
			.attr("x", -(height+margin.top)/2)
			.style("text-anchor", "middle")
			.style("font-family", "Arial")
			.style("font-weight", "bold")
			.style("fill", "#2F4F4F")
			.text("Merchandise Exports (SGD, millions)")

		// Net exporter label
		g.append("text")
			.attr("y", height/3)
			.attr("x", width/3)
			.attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
			.style("text-anchor", "middle")
			.style("font-family", "Arial")
			.style("font-size", "32")
			.style("fill", "#d3d3d3")
			.text("Net Exporter")

		// Net Importer label
		g.append("text")
			.attr("y", height - height/3)
			.attr("x", width - width/3)
			.attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
			.style("text-anchor", "middle")
			.style("font-family", "Arial")
			.style("font-size", "32")
			.style("fill", "#d3d3d3")
			.text("Net Importer")

		var xyLine = g.append("line")
			.attr("x1", 0)
			.attr("y1", height )
			.attr("x2", width -20)
			.attr("y2", 20)
			.attr("stroke-width", 1)
			.attr("stroke", "#708090")
			.attr("transform", "translate(" + margin.left + ", " + margin.top + ")");


		var legend = g.append("g")
			.attr("class", "legend")
			.attr("transform", "translate(" + 0.5*margin.left+ "," + (height + margin.top + 0.4*margin.bottom) +")")


		for (i=0; i < 4; i++) {

			legend.append("circle")
				.attr("cx", (i+1)*width*0.8/4)
				.attr("cy", 10)
				.attr("r", 20/4)
				.attr("fill", colorPalette[i])
			legend.append("text")
				.attr("x", (i+1)*width*0.8/4 + 20/4 + width*0.01)
				.attr("y", 10+ 20/4)
				.attr("fill", colorPalette[i])
				.style("font-family", "Arial")
				.text(regions[i])

		}

		var time = 0;
		var play = true;

		d3.json("merch_trade_data.json", function(data) {

			console.log(data)
			i = 170
			var circles = g.selectAll("circle").data(data[i].countries).enter()
				.append("circle")
				.attr("class", "circleData")
				.attr("r", function(d) { return zScale(d.total)})
				.attr("cx", function(d) { return xScale(+d.import + 1)} )
				.attr("cy", function(d) { return yScale(+d.export + 1)})
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
				.attr("fill", function(d) { return colorScale(d.region); })
				.attr("stroke", "black")
				.attr("stroke-width", "0.8")
				.on("mouseover", mouseoverEvent)
				.on("mouseout", mouseoutEvent)

			var quarter_label = g.append("text")
					.attr("id", "quarter_label")
					.style("font-family", "Arial")
					.attr("font-size", "35px")
					.attr("fill", "#2F4F4F")
					.attr("x", width - 2*margin.left)
					.attr("y", height)
					.text(data[i].quarter)


			var interval = setInterval(function(){
				if (play === true) {
			    	update(time, data)	
			    	quarter_label.text(data[time].quarter)		
			    	time = (time < 170) ? +time + 1 	: 0 
				}
		    	

		    }, 100);

			//rangeSlider function
			d3.select("#rangeSlider").on("input", function() {
				//Always pause when slider is touched
				play = false;
				document.getElementById("play").innerHTML = "Play"
				time = this.value;
				update(time, data);
				quarter_label.text(data[time].quarter)
			})

		})

		function update(i, data) {
			var circles = g.selectAll(".circleData").data(data[i].countries)

			circles.exit().remove()
			circles.enter().append("circle")
				.attr("class", "circleData")
			.merge(circles)
			.transition()
				.attr("r", function(d) { return zScale(d.total)})
				.attr("cx", function(d) { return xScale(+d.import + 1)} )
				.attr("cy", function(d) { return yScale(+d.export + 1)})
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
				.attr("fill", function(d) { return colorScale(d.region); })
			
			circles.on("mouseover", mouseoverEvent)
				.on("mouseout", mouseoutEvent)

			
			document.getElementById("rangeSlider").value=i

			// If  mouseover data is shown, update data on mouseover during animation
			pointLabel = document.getElementsByClassName("pointLabel")
			if (pointLabel.length != 0) {
				hoverCountry = pointLabel[0].innerHTML
				hoverCountryData = data[i].countries.filter(function(d) {
					return d.country == hoverCountry
				})

				//Update total trade, import and export data of hovered over country
				d3.selectAll(".pointLabelData").text(
						"Total Trade: $" + 
						d3.format(".3n")(hoverCountryData[0].total/1000000) + "bn  |  " + 
						"Import: $" + d3.format(".3n")(hoverCountryData[0].import/1000000) + "bn  |  " + 
						"Export: $" + d3.format(".3n")(hoverCountryData[0].export/1000000) + "bn" 
				)

			}
		}

		function mouseoverEvent(d) {

			d3.select(this)
				.style("fill", d3.rgb(this.getAttribute("fill")).brighter())
				.style("stroke", "#d3d3d3")
			text_x = xScale(+d.import +1)
			text_y = yScale(+d.export + 1)

			// Country Text
			g.append("text")
				.attr("class", "pointLabel")
				.attr("x", 0 )
				.attr("y", 0 )
				.style("font-family", "Arial")
				.style("fill", "#2F4F4F")
				.style("font-size", "2em")
				.text(d.country)
				.attr("transform", "translate(" + (margin.left+20) + ",0)")
			// Total Trade Text
			g.append("text")
				.attr("class", "pointLabelData")
				.attr("x", 0 )
				.attr("y", 25 )
				.style("font-family", "Arial")
				.style("fill", "#2F4F4F")
				.style("font-size", "1em")
				.text(
					"Total Trade: $" + d3.format(".3n")(d.total/1000000) + "bn  |  " + 
					"Import: $" + d3.format(".3n")(d.import/1000000) + "bn  |  " + 
					"Export: $" + d3.format(".3n")(d.export/1000000) + "bn" 

				)
				.attr("transform", "translate(" + (margin.left+20) + ",0)")
		}

		function mouseoutEvent(d) {

			d3.select(this)
				.style("fill", function(d) { return colorScale(d.region); })
				.style("stroke", "black")
			d3.selectAll(".pointLabel").remove()
			d3.selectAll(".pointLabelData").remove()
		}

		function reset() {
			time = 0;
			if (play == false) {
				play = true;
			}
		}

		function pausePlay() {

			if (play ==true ) {
				document.getElementById("play").innerHTML = "Play"
			} else {
				document.getElementById("play").innerHTML = "Pause"
			}
			play = !play;

		}



	</script>

</body>
</html>